<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>WiFi Config Editor</title>
    <link href="/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container my-4" id="root">
        <h1 class="mb-4">Loading configuration...</h1>
    </div>

    <script src="/bootstrap.bundle.min.js"></script>
    <script>
        function el(tag, options = {}) {
            const e = document.createElement(tag);
            if (options.classes) e.className = options.classes;
            if (options.text) e.textContent = options.text;
            if (options.html) e.innerHTML = options.html;
            if (options.attrs) {
                for (const [k, v] of Object.entries(options.attrs)) e.setAttribute(k, v);
            }
            if (options.children) options.children.forEach(c => e.appendChild(c));
            return e;
        }

        function labeledInput({ id, labelText, type = 'text', value = '', classes = 'form-control', attrs = {} }) {
            const wrapper = el('div', { classes: 'mb-3' });
            const label = el('label', { text: labelText, attrs: { for: id }, classes: 'form-label' });
            const input = el('input', { attrs: { id, type, value, ...attrs }, classes });
            wrapper.appendChild(label);
            wrapper.appendChild(input);
            return { wrapper, input };
        }

        function labeledCheckbox({ id, labelText, checked = false, classes = 'form-check-input' }) {
            const wrapper = el('div', { classes: 'form-check mb-3' });
            const input = el('input', { attrs: { id, type: 'checkbox' }, classes });
            input.checked = checked;
            const label = el('label', { text: labelText, attrs: { for: id }, classes: 'form-check-label' });
            wrapper.appendChild(input);
            wrapper.appendChild(label);
            return { wrapper, input };
        }

        function createFieldset(legendText) {
            const fs = el('fieldset', { classes: 'border p-3 mb-3 rounded' });
            const legend = el('legend', { text: legendText, classes: 'float-none w-auto px-2' });
            fs.appendChild(legend);
            return fs;
        }

        function createWifiEntry(index, wifiData) {
            const container = el('div', { classes: 'mb-3 border rounded p-3 position-relative' });
            const removeBtn = el('button', {
                classes: 'btn-close position-absolute top-0 end-0 m-2',
                attrs: { type: 'button' }
            });
            removeBtn.title = 'Remove WiFi network';
            removeBtn.onclick = () => container.remove();
            container.appendChild(removeBtn);

            const ssid = labeledInput({ id: `wifi-ssid-${index}`, labelText: 'SSID', value: wifiData.ssid });
            const pass = labeledInput({ id: `wifi-pass-${index}`, labelText: 'Password', type: 'password', value: wifiData.password });
            container.append(ssid.wrapper, pass.wrapper);
            return container;
        }

        function addWifi(container, wifiData = { ssid: '', password: '' }) {
            const index = container.children.length;
            container.appendChild(createWifiEntry(index, wifiData));
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const root = document.getElementById('root');
            root.innerHTML = '<h1 class="mb-4">Edit Configuration Data</h1>';
            let data;

            try {
                const res = await fetch('api/settings');
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                data = await res.json();
            } catch {
                data = {
                    wifi: [
                        { ssid: '', password: '' }
                    ],
                    ap_wifi: { ssid: 'octoprint-signal-tower', password: 'octosignal' },
                    mqtt: { host: '', port: 1883, topics: ['octoPrint/'], username: '', password: '' },
                    rest: { url: '', apiKey: '' },
                    lights: [],
                    states: {},
                    useMqtt: false
                };
            }

            const form = el('form');

            // === Multi WiFi Config ===
            const wifiFS = createFieldset('WiFi Networks');
            const wifiListContainer = el('div', { attrs: { id: 'wifi-list-container' } });
            wifiFS.appendChild(wifiListContainer);
            const addWifiBtn = el('button', {
                text: 'Add WiFi',
                classes: 'btn btn-sm btn-outline-primary mt-2',
                attrs: { type: 'button' }
            });
            addWifiBtn.onclick = () => addWifi(wifiListContainer);
            wifiFS.appendChild(addWifiBtn);

            const wifiEntries = Array.isArray(data.wifi) ? data.wifi : [data.wifi];
            wifiEntries.forEach(w => addWifi(wifiListContainer, w));

            // === AP WiFi Config ===
            const apWifiFS = createFieldset('AP WiFi');
            const apSSID = labeledInput({ id: 'ap-wifi-ssid', labelText: 'SSID', value: data.ap_wifi.ssid });
            const apPass = labeledInput({ id: 'ap-wifi-password', labelText: 'Password', value: data.ap_wifi.password, type: 'password' });
            apWifiFS.append(apSSID.wrapper, apPass.wrapper);

            // === MQTT ===
            const mqttFS = createFieldset('MQTT');
            const mqttHost = labeledInput({ id: 'mqtt-host', labelText: 'Host', value: data.mqtt.host });
            const mqttPort = labeledInput({ id: 'mqtt-port', labelText: 'Port', value: data.mqtt.port, type: 'number', attrs: { min: 0 } });
            const mqttTopics = labeledInput({ id: 'mqtt-topics', labelText: 'Topics (comma separated)', value: data.mqtt.topics.join(', ') });
            const mqttUser = labeledInput({ id: 'mqtt-username', labelText: 'Username', value: data.mqtt.username });
            const mqttPass = labeledInput({ id: 'mqtt-password', labelText: 'Password', value: data.mqtt.password, type: 'password' });
            mqttFS.append(mqttHost.wrapper, mqttPort.wrapper, mqttTopics.wrapper, mqttUser.wrapper, mqttPass.wrapper);

            // === REST ===
            const restFS = createFieldset('REST API');
            const restURL = labeledInput({ id: 'rest-url', labelText: 'URL', value: data.rest.url });
            const restApiKey = labeledInput({ id: 'rest-apiKey', labelText: 'API Key', value: data.rest.apiKey });
            restFS.append(restURL.wrapper, restApiKey.wrapper);

            // === MQTT Toggle ===
            const useMqttCB = labeledCheckbox({ id: 'use-mqtt', labelText: 'Use MQTT', checked: data.useMqtt });

            // === Submit Button ===
            const submitBtn = el('button', {
                text: 'Save Configuration',
                classes: 'btn btn-success mt-3',
                attrs: { type: 'submit' }
            });

            form.append(wifiFS, apWifiFS, mqttFS, restFS, useMqttCB.wrapper, submitBtn);

            form.onsubmit = async (e) => {
                e.preventDefault();

                const updatedConfig = {
                    wifi: Array.from(wifiListContainer.children).map(el => ({
                        ssid: el.querySelector('input[id^="wifi-ssid-"]').value.trim(),
                        password: el.querySelector('input[id^="wifi-pass-"]').value,
                    })).filter(w => w.ssid),
                    ap_wifi: {
                        ssid: document.getElementById('ap-wifi-ssid').value.trim(),
                        password: document.getElementById('ap-wifi-password').value,
                    },
                    mqtt: {
                        host: document.getElementById('mqtt-host').value.trim(),
                        port: parseInt(document.getElementById('mqtt-port').value),
                        topics: document.getElementById('mqtt-topics').value.split(',').map(t => t.trim()).filter(Boolean),
                        username: document.getElementById('mqtt-username').value.trim(),
                        password: document.getElementById('mqtt-password').value,
                    },
                    rest: {
                        url: document.getElementById('rest-url').value.trim(),
                        apiKey: document.getElementById('rest-apiKey').value.trim(),
                    },
                    useMqtt: document.getElementById('use-mqtt').checked
                };

                try {
                    const response = await fetch('api/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updatedConfig)
                    });

                    if (!response.ok) throw new Error(`Server error: ${response.status}`);
                    alert('Configuration saved successfully!');
                } catch (err) {
                    console.error('Failed to save configuration:', err);
                    alert('Failed to save configuration. See console for details.');
                }
            };

            root.appendChild(form);
        });
    </script>
</body>

</html>